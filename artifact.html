<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>*band Artifact Viewer</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div id="artifact-root"></div>
    <script type="text/babel">
        class Artifact {
            constructor(text) {
                const lines = text.split(/\r?\n/);
                this.rawText = text;
                for (const line of lines) {
                    if (!line.trim()) continue;
                    const key = line.charAt(0);
                    const values = line.substring(2).split(":");
                    switch (key) {
                        case "N":
                            [this.serialNumber, this.name] = values.map(v => v.trim());
                            break;
                        case "I":
                            [this.tval, this.sval, this.pval] = values.map(v => v.trim());
                            break;
                        case "W":
                            [this.depth, this.rarity, this.weight, this.cost] = values.map(v => v.trim());
                            break;
                        case "P":
                            [this.base_ac, this.base_damage, this.plus_to_hit, this.plus_to_dam, this.plus_to_ac] = values.map(v => v.trim());
                            break;
                        case "F":
                            if (!this.flags) this.flags = [];
                            this.flags.push(...line.substring(2).split("|").map(f => f.trim()).filter(f => f));
                            break;
                    }
                }
            }
        }

        function parseArtifactData(text) {
            const datas = text.split(/\r?\nN:/);
            const artifacts = [];
            for (let i = 1; i < datas.length; ++i) {
                const artifactText = "N:" + datas[i];
                artifacts.push(new Artifact(artifactText));
            }
            return artifacts;
        }

        function ArtifactDetail({ artifact }) {
            return (
                <div className="card mb-3">
                    <div className="card-header">
                        <strong>No.{artifact.serialNumber}</strong> {artifact.name}
                    </div>
                    <div className="card-body">
                        <div style={{ display: "flex", flexWrap: "wrap", gap: "1.5em" }}>
                            <div>
                                <strong>tval/sval/pval</strong><br />
                                {artifact.tval} / {artifact.sval} / {artifact.pval}
                            </div>
                            <div>
                                <strong>階/レア/重さ/値段</strong><br />
                                {artifact.depth} / {artifact.rarity} / {artifact.weight} / {artifact.cost}
                            </div>
                            <div>
                                <strong>基礎AC/ダメ/命中/ダメ+/AC+</strong><br />
                                {artifact.base_ac} / {artifact.base_damage} / {artifact.plus_to_hit} / {artifact.plus_to_dam} / {artifact.plus_to_ac}
                            </div>
                            <div>
                                <strong>フラグ</strong><br />
                                {artifact.flags ? artifact.flags.join(", ") : "―"}
                            </div>
                        </div>
                        <details style={{ marginTop: "1em" }}>
                            <summary>生データ</summary>
                            <pre style={{ whiteSpace: "pre-wrap" }}>{artifact.rawText}</pre>
                        </details>
                    </div>
                </div>
            );
        }

        function ArtifactViewer() {
            const [artifacts, setArtifacts] = React.useState([]);
            const [progress, setProgress] = React.useState(0);
            const [loading, setLoading] = React.useState(false);

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setLoading(true);
                        setProgress(0);
                        setTimeout(() => {
                            const parsed = parseArtifactData(e.target.result);
                            setArtifacts(parsed);
                            setProgress(100);
                            setLoading(false);
                        }, 0);
                    };
                    reader.readAsText(file);
                }
            };

            return (
                <div className="container mt-4">
                    <h1>*band アーティファクトリスト</h1>
                    <p>アーティファクト定義ファイルを読み込んで下さい</p>
                    <input type="file" accept=".txt" onChange={handleFileChange} />
                    {loading && (
                        <div style={{ margin: "1em 0" }}>
                            <div style={{
                                width: "100%",
                                background: "#eee",
                                borderRadius: "4px",
                                overflow: "hidden",
                                height: "1.2em"
                            }}>
                                <div style={{
                                    width: `${progress}%`,
                                    background: "#4caf50",
                                    height: "100%",
                                    transition: "width 0.2s"
                                }} />
                            </div>
                            <div style={{ textAlign: "right", fontSize: "0.9em" }}>{progress}%</div>
                        </div>
                    )}
                    <div>
                        {artifacts.map(artifact => (
                            <ArtifactDetail key={artifact.serialNumber} artifact={artifact} />
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ArtifactViewer />, document.getElementById('artifact-root'));